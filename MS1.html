<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wage Tracker App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- SheetJS (xlsx) for Excel Export -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable plugin for table generation in PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbar issues with animated background */
        }

        /* Dynamic Liquid Glass Background Effect - Darker Green Gradient */
        .dynamic-background {
            /* Deeper green with almost black ends, slightly more vibrant */
            background: linear-gradient(135deg, #011E18, #033D30, #011E18);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Liquid Glass Effect for Cards/Elements - Adjusted for more "liquid" feel */
        .liquid-glass {
            background-color: rgba(255, 255, 255, 0.12); /* Slightly more transparent */
            backdrop-filter: blur(12px) saturate(180%); /* Increased blur for more glass effect */
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.15); /* Finer, less obtrusive border */
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.15); /* Stronger, softer shadow */
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }

        .liquid-glass:hover {
            box-shadow: 0 20px 80px 0 rgba(0, 0, 0, 0.25); /* More pronounced hover shadow */
            transform: translateY(-2px); /* Slight lift on hover */
        }

        /* Custom scrollbar for better aesthetics */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05); /* Lighter track */
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3); /* Lighter thumb */
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5); /* Hover effect for thumb */
        }

        /* Hide number input arrows */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Custom styles for text within liquid glass to ensure readability */
        /* Increased contrast for dark text */
        .liquid-glass-text-dark {
            color: #000000; /* Pure black for highest contrast */
        }
        .liquid-glass-text-muted {
            color: #2D3748; /* Darker gray for labels/muted info */
        }

        /* Styling for dropdown options to be readable on dark background */
        select option {
            background-color: #011E18; /* Dark background for options */
            color: #E2E8F0; /* Light text color for options */
        }

        /* Styling for entry list items for better alignment */
        .entry-item-layout {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 8px; /* Gap between elements */
        }

        .entry-item-layout > div {
            flex-shrink: 0; /* Prevent shrinking */
        }

        .entry-date {
            min-width: 90px; /* Ensure date has enough space */
            text-align: left;
        }

        .entry-details {
            flex-grow: 1; /* Allow details to take remaining space */
            text-align: left;
            white-space: nowrap; /* Prevent wrapping details */
        }

        .entry-total {
            min-width: 80px; /* Ensure total has enough space */
            text-align: right;
        }

        /* Monthly separator style for entry history */
        .month-history-separator {
            width: 100%;
            height: 1px;
            background-color: rgba(255, 255, 255, 0.2); /* Thin white separator */
            margin: 15px 0;
        }

        /* Style for dark green total cards */
        .total-card-dark-green {
            background-color: rgba(5, 79, 63, 0.9); /* Dark green with more transparency */
            color: #FFFFFF; /* White text for contrast */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Maintain liquid glass border */
        }
        .total-card-dark-green .liquid-glass-text-dark {
            color: #E2E8F0; /* Lighter text for headers in dark green cards */
        }
        .total-card-dark-green .liquid-glass-text-muted {
            color: #A7F3D0; /* Lighter green for muted text in dark green cards */
        }
        .total-card-dark-green .text-emerald-800 {
            color: #6EE7B7; /* Lighter emerald for values in dark green cards */
        }

        /* Specific styles for gold accents */
        .gold-text {
            color: #FFD700; /* Gold color */
        }
        .gold-accent-text {
            color: #FACC15; /* Tailwind amber-400 for accent values */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen items-center justify-center p-4 text-gray-100 relative">
    <!-- Dynamic Background Element -->
    <div class="dynamic-background"></div>

    <!-- Message Box for Alerts -->
    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="liquid-glass p-8 rounded-xl shadow-xl max-w-sm text-center liquid-glass-text-dark">
            <h3 id="messageTitle" class="text-xl font-bold mb-4"></h3>
            <p id="messageContent" class="mb-6"></p>
            <button onclick="closeMessageBox()" class="bg-emerald-700 hover:bg-emerald-800 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">OK</button>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="liquid-glass p-8 w-full max-w-md mx-auto my-8 flex flex-col items-center justify-center">
        <div class="text-center mb-8">
            <i class="fas fa-wallet text-5xl text-emerald-400 mb-4"></i>
            <h2 class="text-3xl font-bold text-emerald-300">Wage Tracker Login</h2>
        </div>
        <input type="text" id="username" placeholder="Username" class="liquid-glass w-full p-3 mb-4 text-center liquid-glass-text-dark placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-400">
        <input type="password" id="password" placeholder="Password" class="liquid-glass w-full p-3 mb-6 text-center liquid-glass-text-dark placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-400">
        <button id="loginBtn" class="bg-emerald-700 hover:bg-emerald-800 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 w-full transform hover:scale-105">Login</button>
        <p class="mt-4 text-sm text-gray-400">Hint: user / pass</p>
    </div>

    <!-- Main App Screen -->
    <div id="mainApp" class="hidden w-full max-w-5xl mx-auto my-8 flex flex-col liquid-glass p-6 md:p-8">
        <!-- Banner -->
        <div class="flex items-center justify-between bg-emerald-950 text-white p-4 rounded-t-xl mb-6 shadow-lg">
            <div class="flex items-center">
                <!-- Simple SVG Logo Placeholder with Gold Accent -->
                <svg class="w-10 h-10 mr-3 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V9m0 3v2m0 3.5V18m0-8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V9m0 3v2m0 3.5V18"></path>
                </svg>
                <h1 class="text-3xl font-bold">Wage Tracker</h1>
            </div>
            <button id="logoutBtn" class="bg-black hover:bg-gray-900 text-amber-300 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">Logout</button>
        </div>

        <!-- Employee Management (Full Width) -->
        <div class="liquid-glass p-5 flex flex-col mb-6">
            <h2 class="text-2xl font-semibold mb-4 liquid-glass-text-dark">Employees</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4 items-center">
                <div class="flex gap-2 w-full sm:w-1/2">
                    <input type="text" id="employeeNameInput" placeholder="Employee Name" class="liquid-glass flex-grow p-3 liquid-glass-text-dark placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <button id="addEmployeeBtn" class="bg-emerald-700 hover:bg-emerald-800 text-white py-2 px-4 rounded-lg shadow-md transition duration-200">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                <div class="flex items-center gap-2 w-full sm:w-1/2">
                    <label for="employeeSelect" class="sr-only">Select Employee</label>
                    <select id="employeeSelect" class="liquid-glass flex-grow p-3 liquid-glass-text-dark focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option value="">-- Select Employee --</option>
                        <!-- Employee options will be dynamically added here -->
                    </select>
                    <button id="deleteSelectedEmployeeBtn" class="bg-red-700 hover:bg-red-800 text-white py-2 px-4 rounded-lg shadow-md transition duration-200" title="Delete Selected Employee">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Entry (Full Width) -->
        <div class="liquid-glass p-5 mb-6 w-full">
            <h2 class="text-2xl font-semibold mb-4 liquid-glass-text-dark">Add Wage Entry</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="entryDate" class="block text-sm font-medium liquid-glass-text-muted">Date</label>
                    <input type="date" id="entryDate" class="liquid-glass w-full p-3 mt-1 liquid-glass-text-dark focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="hoursWorked" class="block text-sm font-medium liquid-glass-text-muted">Hours Worked</label>
                    <input type="number" id="hoursWorked" placeholder="e.g., 8.5" step="0.5" class="liquid-glass w-full p-3 mt-1 liquid-glass-text-dark placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label for="wagePerHour" class="block text-sm font-medium liquid-glass-text-muted">Wage per Hour (R)</label>
                    <input type="number" id="wagePerHour" placeholder="e.g., 25.00" step="0.01" class="liquid-glass w-full p-3 mt-1 liquid-glass-text-dark placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
            </div>
            <button id="addEntryBtn" class="bg-emerald-700 hover:bg-emerald-800 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 w-full transform hover:scale-105">
                <i class="fas fa-plus-circle"></i> Add Entry
            </button>
        </div>

        <!-- Entry History (Full Width) -->
        <div class="liquid-glass p-5 mb-6 w-full">
            <h2 class="text-2xl font-semibold mb-4 liquid-glass-text-dark">Entry History</h2>
            <div id="entryHistoryContainer" class="max-h-80 overflow-y-auto custom-scroll">
                <ul id="entryHistoryList" class="space-y-2">
                    <!-- Entry items will be dynamically added here -->
                </ul>
                <p id="noEntriesMessage" class="text-gray-400 text-center py-4 hidden">No entries for this employee yet.</p>
            </div>
        </div>

        <!-- Totals for [Employee Name] Header - Now its own liquid-glass card -->
        <div class="liquid-glass p-4 mt-6 mb-6">
            <h2 class="text-2xl font-semibold liquid-glass-text-dark text-center">Totals for <span id="selectedEmployeeName" class="text-emerald-900">None</span></h2>
        </div>

        <!-- Monthly and Grand Totals (Side-by-side on larger screens, each in their own dark green liquid-glass card) -->
        <div class="flex flex-col lg:flex-row gap-6 mb-6">
            <!-- Monthly Totals Card -->
            <div class="flex-1 liquid-glass p-5 rounded-lg total-card-dark-green">
                <h3 class="text-xl font-bold liquid-glass-text-dark mb-3">Monthly Totals</h3>
                <div id="monthlyTotalsList" class="space-y-3">
                    <!-- Monthly totals for each month will be dynamically added here -->
                    <p class="text-gray-300 text-center" id="noMonthlyTotalsMessage">No monthly totals yet.</p>
                </div>
            </div>

            <!-- Grand Totals Card -->
            <div class="flex-1 liquid-glass p-5 rounded-lg total-card-dark-green">
                <h3 class="text-xl font-bold liquid-glass-text-dark mb-3">Grand Totals</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-col items-center">
                        <p class="text-sm liquid-glass-text-muted">Hours</p>
                        <p id="grandTotalHours" class="text-xl font-bold gold-accent-text">0</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <p class="text-sm liquid-glass-text-muted">Wage</p>
                        <p id="grandTotalWage" class="text-xl font-bold gold-accent-text">R0.00</p>
                    </div>
                </div>
            </div>
        </div>


        <!-- Export Buttons - Purple and Integrated into a liquid-glass card -->
        <div class="liquid-glass p-5 flex flex-col md:flex-row gap-4 mt-8 justify-center">
            <button id="exportExcelBtn" class="bg-purple-700 hover:bg-purple-800 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 transform hover:scale-105 flex items-center justify-center">
                <i class="fas fa-file-excel mr-2"></i> Export to Excel
            </button>
            <button id="exportPdfBtn" class="bg-purple-700 hover:bg-purple-800 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 transform hover:scale-105 flex items-center justify-center">
                <i class="fas fa-file-pdf mr-2"></i> Export to PDF
            </button>
        </div>
    </div>

    <script>
        // --- Global Variables and Initial Setup ---
        // Using `let` for variables that will be reassigned
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        // Correctly retrieving selectedEmployeeId as a string
        let selectedEmployeeId = localStorage.getItem('selectedEmployeeId') || null;
        let isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

        // --- DOM Element References ---
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const employeeNameInput = document.getElementById('employeeNameInput');
        const addEmployeeBtn = document.getElementById('addEmployeeBtn');
        const employeeSelect = document.getElementById('employeeSelect');
        const deleteSelectedEmployeeBtn = document.getElementById('deleteSelectedEmployeeBtn');
        const selectedEmployeeNameSpan = document.getElementById('selectedEmployeeName');
        // Removed direct spans for monthly totals, now dynamic list
        const grandTotalHoursSpan = document.getElementById('grandTotalHours');
        const grandTotalWageSpan = document.getElementById('grandTotalWage');
        const monthlyTotalsList = document.getElementById('monthlyTotalsList'); // New container for monthly totals
        const noMonthlyTotalsMessage = document.getElementById('noMonthlyTotalsMessage'); // Message for no monthly totals
        const entryDateInput = document.getElementById('entryDate');
        const hoursWorkedInput = document.getElementById('hoursWorked');
        const wagePerHourInput = document.getElementById('wagePerHour');
        const addEntryBtn = document.getElementById('addEntryBtn');
        const entryHistoryList = document.getElementById('entryHistoryList');
        const noEntriesMessage = document.getElementById('noEntriesMessage');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const messageBox = document.getElementById('messageBox');
        const messageTitle = document.getElementById('messageTitle');
        const messageContent = document.getElementById('messageContent');

        // Set default date to today
        entryDateInput.valueAsDate = new Date();

        // --- Helper Functions ---

        /**
         * Displays a custom message box instead of alert().
         * @param {string} title - The title of the message.
         * @param {string} content - The content of the message.
         */
        function showMessageBox(title, content) {
            messageTitle.textContent = title;
            messageContent.innerHTML = content;
            messageBox.classList.remove('hidden');
        }

        /**
         * Hides the custom message box.
         */
        function closeMessageBox() {
            messageBox.classList.add('hidden');
        }

        /**
         * Saves the current state of employees and selected employee to localStorage.
         */
        function saveState() {
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('selectedEmployeeId', selectedEmployeeId);
            localStorage.setItem('isLoggedIn', isLoggedIn);
        }

        /**
         * Renders the employee list in the UI as a dropdown.
         */
        function renderEmployeeList() {
            employeeSelect.innerHTML = '<option value="">-- Select Employee --</option>';

            if (employees.length === 0) {
                selectedEmployeeId = null;
                employeeSelect.value = "";
            }

            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = employee.name;
                employeeSelect.appendChild(option);
            });

            if (selectedEmployeeId && employees.some(emp => emp.id === selectedEmployeeId)) {
                employeeSelect.value = selectedEmployeeId;
            } else {
                selectedEmployeeId = null;
                employeeSelect.value = "";
            }
            updateUI();
        }

        /**
         * Updates the display of the currently selected employee name.
         */
        function updateSelectedEmployeeDisplayName() {
            const selected = employees.find(emp => emp.id === selectedEmployeeId);
            selectedEmployeeNameSpan.textContent = selected ? selected.name : 'None';
        }

        /**
         * Renders the entry history for the selected employee, with monthly separators but no monthly subtotals.
         */
        function renderEntryHistory() {
            entryHistoryList.innerHTML = '';
            noEntriesMessage.classList.add('hidden');

            const selected = employees.find(emp => emp.id === selectedEmployeeId);

            if (!selected || selected.entries.length === 0) {
                noEntriesMessage.classList.remove('hidden');
                return;
            }

            // Sort entries by date, newest first
            const sortedEntries = [...selected.entries].sort((a, b) => new Date(b.date) - new Date(a.date));

            let currentMonthYear = '';

            sortedEntries.forEach(entry => {
                const entryDate = new Date(entry.date);
                const monthYear = entryDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });

                // Add month separator if month changes
                if (monthYear !== currentMonthYear) {
                    currentMonthYear = monthYear;
                    const monthHeaderLi = document.createElement('li');
                    monthHeaderLi.className = 'w-full text-center mt-4 mb-2';
                    monthHeaderLi.innerHTML = `
                        <div class="text-lg font-bold liquid-glass-text-dark mb-1">${monthYear}</div>
                        <div class="month-history-separator"></div>
                    `;
                    entryHistoryList.appendChild(monthHeaderLi);
                }

                const li = document.createElement('li');
                li.className = `flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 rounded-lg liquid-glass mb-2 liquid-glass-text-dark`;
                li.innerHTML = `
                    <div class="entry-item-layout w-full">
                        <div class="entry-date font-bold text-gray-800">${entry.date}:</div>
                        <div class="entry-details ml-2">Hours: ${entry.hours.toFixed(1)}, Wage/Hr: R${entry.wagePerHour.toFixed(2)}</div>
                        <div class="entry-total font-bold text-emerald-800">Total: R${(entry.hours * entry.wagePerHour).toFixed(2)}</div>
                        <button data-id="${entry.id}" class="delete-entry-btn bg-red-700 hover:bg-red-800 text-white p-1 rounded-full shadow transition duration-200 ml-0 sm:ml-4 mt-2 sm:mt-0" title="Delete Entry">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                entryHistoryList.appendChild(li);
            });
        }

        /**
         * Calculates and displays monthly and grand totals for the selected employee.
         * All monthly totals are now displayed in the dedicated "Monthly Totals" card.
         */
        function calculateAndDisplayTotals() {
            monthlyTotalsList.innerHTML = ''; // Clear previous monthly totals
            noMonthlyTotalsMessage.classList.add('hidden'); // Hide default message initially

            const selected = employees.find(emp => emp.id === selectedEmployeeId);
            let grandTotalHours = 0;
            let grandTotalWage = 0;

            const monthlySummary = new Map(); // Map<"YYYY-MM", { hours: N, wage: N }>

            if (selected) {
                // Calculate grand totals and populate monthlySummary
                selected.entries.forEach(entry => {
                    const entryDate = new Date(entry.date);
                    const monthKey = entryDate.getFullYear() + '-' + String(entryDate.getMonth() + 1).padStart(2, '0');
                    const entryTotal = entry.hours * entry.wagePerHour;

                    grandTotalHours += entry.hours;
                    grandTotalWage += entryTotal;

                    if (!monthlySummary.has(monthKey)) {
                        monthlySummary.set(monthKey, { hours: 0, wage: 0 });
                    }
                    const summary = monthlySummary.get(monthKey);
                    summary.hours += entry.hours;
                    summary.wage += entryTotal;
                });

                // Render monthly totals in the list
                if (monthlySummary.size > 0) {
                    // Sort months in reverse chronological order
                    const sortedMonthKeys = Array.from(monthlySummary.keys()).sort().reverse();

                    sortedMonthKeys.forEach(monthKey => {
                        const summary = monthlySummary.get(monthKey);
                        const [year, monthNum] = monthKey.split('-');
                        const monthName = new Date(year, monthNum - 1, 1).toLocaleString('en-US', { month: 'long', year: 'numeric' });

                        const monthLi = document.createElement('div');
                        monthLi.className = `flex justify-between items-center bg-emerald-900 text-white p-2 rounded-lg shadow-sm`;
                        monthLi.innerHTML = `
                            <span class="font-bold">${monthName}:</span>
                            <span>Hours: <span class="gold-accent-text">${summary.hours.toFixed(1)}</span></span>
                            <span>Wage: <span class="gold-accent-text">R${summary.wage.toFixed(2)}</span></span>
                        `;
                        monthlyTotalsList.appendChild(monthLi);
                    });
                } else {
                    noMonthlyTotalsMessage.classList.remove('hidden');
                }
            } else {
                noMonthlyTotalsMessage.classList.remove('hidden');
            }

            // Update grand total display
            grandTotalHoursSpan.textContent = grandTotalHours.toFixed(1);
            grandTotalWageSpan.textContent = `R${grandTotalWage.toFixed(2)}`;
        }

        /**
         * Centralized function to update all dynamic UI elements.
         */
        function updateUI() {
            updateSelectedEmployeeDisplayName();
            renderEntryHistory();
            calculateAndDisplayTotals(); // This now updates the dynamic monthly list
        }

        /**
         * Handles the login logic.
         */
        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (username === 'user' && password === 'pass') {
                isLoggedIn = true;
                saveState();
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                renderEmployeeList();
                showMessageBox('Login Successful', 'Welcome to Wage Tracker!');
            } else {
                showMessageBox('Login Failed', 'Incorrect username or password. Please try again.');
            }
        }

        /**
         * Handles the logout logic.
         */
        function handleLogout() {
            isLoggedIn = false;
            selectedEmployeeId = null;
            employees = [];
            saveState();
            loginScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            usernameInput.value = '';
            passwordInput.value = '';
            showMessageBox('Logged Out', 'You have been successfully logged out.');
        }

        /**
         * Adds a new employee.
         */
        function addEmployee() {
            const name = employeeNameInput.value.trim();
            if (name) {
                const newEmployee = {
                    id: crypto.randomUUID(),
                    name: name,
                    entries: []
                };
                employees.push(newEmployee);
                employeeNameInput.value = '';
                saveState();
                renderEmployeeList();
                selectedEmployeeId = newEmployee.id;
                employeeSelect.value = selectedEmployeeId;
                updateUI();
                showMessageBox('Success', `Employee "${name}" added and selected.`);
            } else {
                showMessageBox('Input Required', 'Please enter an employee name.');
            }
        }

        /**
         * Deletes the currently selected employee.
         */
        function deleteSelectedEmployee() {
            if (!selectedEmployeeId) {
                showMessageBox('No Employee Selected', 'Please select an employee to delete.');
                return;
            }

            messageTitle.textContent = 'Confirm Deletion';
            messageContent.innerHTML = `Are you sure you want to delete the selected employee and all their data?<br><br>
                <div class="flex justify-center gap-4 mt-4">
                    <button id="confirmDeleteBtn" class="bg-red-700 hover:bg-red-800 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">Yes, Delete</button>
                    <button onclick="closeMessageBox()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">Cancel</button>
                </div>`;
            messageBox.classList.remove('hidden');

            document.getElementById('confirmDeleteBtn').onclick = () => {
                const deletedEmployeeName = employees.find(emp => emp.id === selectedEmployeeId)?.name;
                employees = employees.filter(emp => emp.id !== selectedEmployeeId);
                selectedEmployeeId = null;
                saveState();
                renderEmployeeList();
                closeMessageBox();
                showMessageBox('Deleted', `Employee "${deletedEmployeeName || 'Unknown'}" deleted.`);
            };
        }

        /**
         * Selects an employee based on dropdown change.
         * @param {string} id - The ID of the employee to select.
         */
        function selectEmployee(id) {
            selectedEmployeeId = id;
            saveState();
            updateUI();
            const selected = employees.find(emp => emp.id === selectedEmployeeId);
            if (selected) {
                 showMessageBox('Employee Selected', `You have selected: ${selected.name}`);
            } else {
                 showMessageBox('Employee Unselected', `No employee is currently selected.`);
            }
        }

        /**
         * Adds a new wage entry for the selected employee.
         */
        function addEntry() {
            if (!selectedEmployeeId) {
                showMessageBox('No Employee Selected', 'Please select an employee first to add an entry.');
                return;
            }

            const date = entryDateInput.value;
            const hours = parseFloat(hoursWorkedInput.value);
            const wagePerHour = parseFloat(wagePerHourInput.value);

            if (!date || isNaN(hours) || isNaN(wagePerHour) || hours <= 0 || wagePerHour <= 0) {
                showMessageBox('Invalid Input', 'Please enter valid date, positive hours worked, and positive wage per hour.');
                return;
            }

            const selected = employees.find(emp => emp.id === selectedEmployeeId);
            if (selected) {
                const newEntry = {
                    id: crypto.randomUUID(),
                    date: date,
                    hours: hours,
                    wagePerHour: wagePerHour
                };
                selected.entries.push(newEntry);
                saveState();
                updateUI();
                showMessageBox('Entry Added', 'Wage entry successfully added.');
                hoursWorkedInput.value = '';
                wagePerHourInput.value = '';
                entryDateInput.valueAsDate = new Date();
            }
        }

        /**
         * Deletes a specific entry for the selected employee.
         * @param {string} entryId - The ID of the entry to delete.
         */
        function deleteEntry(entryId) {
            if (!selectedEmployeeId) return;

            messageTitle.textContent = 'Confirm Deletion';
            messageContent.innerHTML = `Are you sure you want to delete this wage entry?<br><br>
                <div class="flex justify-center gap-4 mt-4">
                    <button id="confirmDeleteEntryBtn" class="bg-red-700 hover:bg-red-800 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">Yes, Delete</button>
                    <button onclick="closeMessageBox()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">Cancel</button>
                </div>`;
            messageBox.classList.remove('hidden');

            document.getElementById('confirmDeleteEntryBtn').onclick = () => {
                const selected = employees.find(emp => emp.id === selectedEmployeeId);
                if (selected) {
                    selected.entries = selected.entries.filter(entry => entry.id !== entryId);
                    saveState();
                    updateUI();
                    closeMessageBox();
                    showMessageBox('Deleted', 'Wage entry deleted.');
                }
                };
        }

        /**
         * Exports all employee data to an Excel file.
         */
        function exportToExcel() {
            if (employees.length === 0) {
                showMessageBox('No Data', 'No employee data to export.');
                return;
            }

            const workbook = XLSX.utils.book_new();

            employees.forEach(employee => {
                const worksheetData = [
                    ['Wage Tracker Report for:'],
                    ['Employee Name:', employee.name],
                    [''],
                    ['Date', 'Hours Worked', 'Wage per Hour (R)', 'Total Wage (R)']
                ];

                employee.entries.forEach(entry => {
                    const totalWage = (entry.hours * entry.wagePerHour).toFixed(2);
                    worksheetData.push([entry.date, entry.hours.toFixed(1), entry.wagePerHour.toFixed(2), totalWage]);
                });

                let empTotalHours = 0;
                let empTotalWage = 0;
                employee.entries.forEach(entry => {
                    empTotalHours += entry.hours;
                    empWage += entry.hours * entry.wagePerHour;
                });

                worksheetData.push(['', '', '', '']);
                worksheetData.push(['Employee Total Hours:', empTotalHours.toFixed(1), 'Employee Total Wage:', `R${empTotalWage.toFixed(2)}`]);

                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                XLSX.utils.book_append_sheet(workbook, worksheet, employee.name.substring(0, 30));
            });

            const summaryData = [
                ['Overall Wage Tracker Summary'],
                [''],
                ['Employee Name', 'Total Hours', 'Total Wage (R)']
            ];
            let grandTotalHoursAll = 0;
            let grandTotalWageAll = 0;

            employees.forEach(employee => {
                let empHours = 0;
                let empWage = 0;
                employee.entries.forEach(entry => {
                    empHours += entry.hours;
                    empWage += entry.hours * entry.wagePerHour;
                });
                summaryData.push([employee.name, empHours.toFixed(1), empWage.toFixed(2)]);
                grandTotalHoursAll += empHours;
                grandTotalWageAll += empWage;
            });
            summaryData.push(['', '', '']);
            summaryData.push(['Grand Total All Employees:', grandTotalHoursAll.toFixed(1), `R${grandTotalWageAll.toFixed(2)}`]);

            const summaryWorksheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(workbook, summaryWorksheet, 'Summary');

            XLSX.writeFile(workbook, 'WageTracker_Report.xlsx');
            showMessageBox('Export Successful', 'Data exported to WageTracker_Report.xlsx');
        }

        /**
         * Exports all employee data to a PDF file.
         */
        function exportToPdf() {
            if (employees.length === 0) {
                showMessageBox('No Data', 'No employee data to export.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let y = 10;
            const margin = 10;
            const pageWidth = doc.internal.pageSize.getWidth();

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(22);
            doc.setTextColor('#047857'); /* Darker emerald for PDF header */
            doc.text("Wage Tracker Report", pageWidth / 2, y, { align: 'center' });
            y += 10;
            doc.setFontSize(10);
            doc.setTextColor('#4A5568'); /* Dark gray for generated date */
            doc.text(`Generated on: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, pageWidth / 2, y, { align: 'center' });
            y += 15;

            employees.forEach((employee, index) => {
                if (y + 40 > doc.internal.pageSize.getHeight() && index > 0) {
                    doc.addPage();
                    y = margin;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(22);
                    doc.setTextColor('#047857');
                    doc.text("Wage Tracker Report (Cont.)", pageWidth / 2, y, { align: 'center' });
                    y += 15;
                }

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.setTextColor('#054F3F'); /* Even darker green for employee name in PDF */
                doc.text(`Employee: ${employee.name}`, margin, y);
                y += 10;

                const tableColumn = ["Date", "Hours Worked", "Wage per Hour (R)", "Total Wage (R)"];
                const tableRows = [];
                let empTotalHours = 0;
                let empTotalWage = 0;

                employee.entries.forEach(entry => {
                    const totalWage = (entry.hours * entry.wagePerHour).toFixed(2);
                    tableRows.push([entry.date, entry.hours.toFixed(1), entry.wagePerHour.toFixed(2), totalWage]);
                    empTotalHours += entry.hours;
                    empTotalWage += entry.hours * entry.wagePerHour;
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: y,
                    theme: 'grid',
                    styles: {
                        font: 'helvetica',
                        fontSize: 10,
                        cellPadding: 3,
                        halign: 'center',
                        textColor: '#1A202C' /* Black text in PDF table cells */
                    },
                    headStyles: {
                        fillColor: '#38A169', /* Darker emerald for table header */
                        textColor: '#FFFFFF', /* White text in table header */
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    alternateRowStyles: {
                        fillColor: '#D1FAE5' /* Lightest emerald for alternate rows */
                    },
                    margin: { left: margin, right: margin },
                    didDrawPage: function (data) {
                        y = data.cursor.y;
                    }
                });

                y += 5;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(12);
                doc.setTextColor('#374151');
                doc.text(`Total Hours for ${employee.name}: ${empTotalHours.toFixed(1)}`, margin, y);
                y += 7;
                doc.text(`Total Wage for ${employee.name}: R${empTotalWage.toFixed(2)}`, margin, y);
                y += 15;

                if (index < employees.length - 1) {
                    doc.setDrawColor('#047857'); /* Dark emerald line */
                    doc.line(margin, y, pageWidth - margin, y);
                    y += 5;
                }
            });

            let grandTotalHoursAll = 0;
            let grandTotalWageAll = 0;
            employees.forEach(employee => {
                employee.entries.forEach(entry => {
                    grandTotalHoursAll += entry.hours;
                    grandTotalWageAll += entry.hours * entry.wagePerHour;
                });
            });

            if (y + 30 > doc.internal.pageSize.getHeight()) {
                doc.addPage();
                y = margin;
            }

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.setTextColor('#047857'); /* Dark emerald for grand totals */
            doc.text("Overall Grand Totals", margin, y);
            y += 10;
            doc.setFontSize(14);
            doc.text(`Total Hours Across All Employees: ${grandTotalHoursAll.toFixed(1)}`, margin, y);
            y += 8;
            doc.text(`Total Wage Across All Employees: R${grandTotalWageAll.toFixed(2)}`, margin, y);

            doc.save('WageTracker_Report.pdf');
            showMessageBox('Export Successful', 'Data exported to WageTracker_Report.pdf');
        }

        // --- Event Listeners ---
        loginBtn.addEventListener('click', handleLogin);
        usernameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') passwordInput.focus();
        });
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleLogin();
        });

        logoutBtn.addEventListener('click', handleLogout);
        addEmployeeBtn.addEventListener('click', addEmployee);
        employeeNameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addEmployee();
        });

        employeeSelect.addEventListener('change', function(e) {
            selectEmployee(e.target.value);
        });

        deleteSelectedEmployeeBtn.addEventListener('click', deleteSelectedEmployee);

        addEntryBtn.addEventListener('click', addEntry);
        [entryDateInput, hoursWorkedInput, wagePerHourInput].forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addEntry();
            });
        });

        entryHistoryList.addEventListener('click', function(e) {
            if (e.target.closest('.delete-entry-btn')) {
                deleteEntry(e.target.closest('.delete-entry-btn').dataset.id);
            }
        });

        exportExcelBtn.addEventListener('click', exportToExcel);
        exportPdfBtn.addEventListener('click', exportToPdf);

        // --- Initial Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            selectedEmployeeId = localStorage.getItem('selectedEmployeeId');
            if (isLoggedIn) {
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                renderEmployeeList();
            } else {
                loginScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
